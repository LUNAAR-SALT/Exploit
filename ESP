local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local function createESP(player)
    local esp = {}

    -- Line ESP
    esp.line = Instance.new("Frame")
    esp.line.Parent = game.Players.LocalPlayer.PlayerGui
    esp.line.BackgroundColor3 = Color3.new(255, 255, 255)
    esp.line.BorderSizePixel = 0
    esp.line.Size = UDim2.new(0, 2, 0, 50) -- Adjust size as needed
    esp.line.Visible = false

    -- Box ESP
    esp.box = Instance.new("Frame")
    esp.box.Parent = game.Players.LocalPlayer.PlayerGui
    esp.box.BackgroundColor3 = Color3.new(255, 0, 0)
    esp.box.BorderSizePixel = 2
    esp.box.Size = UDim2.new(0, 50, 0, 50) -- Adjust size as needed
    esp.box.Visible = false

    -- Name ESP
    esp.name = Drawing.new("Text")
    esp.name.Visible = false
    esp.name.Center = true
    esp.name.Outline = false
    esp.name.Font = Enum.Font.SourceSansBold
    esp.name.Size = 14
    esp.name.Color = Color3.new(255, 255, 255)
    
    local function updateESP()
        local character = player.Character
        if character then
            local head = character:FindFirstChild("Head")
            local humanoid = character:FindFirstChild("Humanoid")

            if head and humanoid then
                -- Line ESP
                local position, onScreen = Camera:WorldToViewportPoint(head.Position)
                esp.line.Position = UDim2.new(0, position.X, 0, position.Y)
                esp.line.Visible = onScreen

                -- Box ESP
                local hrpPos, hrpOnScreen = Camera:WorldToViewportPoint(character.HumanoidRootPart.Position)
                esp.box.Position = UDim2.new(0, hrpPos.X, 0, hrpPos.Y)
                esp.box.Visible = hrpOnScreen

                -- Name ESP
                local hrpPosName, hrpOnScreenName = Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 3, 0))
                esp.name.Position = Vector2.new(hrpPosName.X, hrpPosName.Y)
                esp.name.Text = player.Name
                esp.name.Visible = hrpOnScreenName
            else
                -- If Head or Humanoid is missing, hide all ESP elements
                esp.line.Visible = false
                esp.box.Visible = false
                esp.name.Visible = false
            end
        else
            -- If Character is missing, hide all ESP elements
            esp.line.Visible = false
            esp.box.Visible = false
            esp.name.Visible = false
        end
    end

    local function removeESP()
        esp.line:Destroy()
        esp.box:Destroy()
        esp.name:Remove()
    end

    esp.remove = removeESP -- You can use this function to remove all ESP elements when needed

    RunService.RenderStepped:Connect(updateESP)
end

local function playerAdded(player)
    if player ~= Players.LocalPlayer then
        createESP(player)
    end
end

Players.PlayerAdded:Connect(playerAdded)

-- For players already in the game
for _, player in ipairs(Players:GetPlayers()) do
    if player ~= Players.LocalPlayer then
        playerAdded(player)
    end
end
