local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = game.Workspace.CurrentCamera

-- Function to create a BillboardGui for a player
local function createESP(player)
    local playerGui = player:WaitForChild("PlayerGui")

    local esp = Instance.new("BillboardGui")
    esp.Name = "ESP"
    esp.Adornee = player.Character:WaitForChild("Head")
    esp.AlwaysOnTop = true
    esp.Size = UDim2.new(0, 100, 0, 20)
    esp.StudsOffset = Vector3.new(0, 2, 0)

    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "NameLabel"
    nameLabel.Size = UDim2.new(1, 0, 1, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = player.Name
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.TextColor3 = Color3.new(1, 1, 1)
    nameLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    nameLabel.TextStrokeTransparency = 0.5
    nameLabel.TextScaled = true
    nameLabel.Parent = esp

    esp.Parent = playerGui
end

-- Function to update ESP positions
local function updateESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer then
            local esp = player:FindFirstChild("PlayerGui"):FindFirstChild("ESP")
            if esp then
                local head = player.Character:FindFirstChild("Head")
                if head then
                    local position = Camera:WorldToViewportPoint(head.Position)
                    esp.Position = UDim2.new(0, position.X, 0, position.Y)
                else
                    esp:Destroy() -- Remove ESP if the player doesn't have a head
                end
            else
                createESP(player)
            end
        end
    end
end

-- Connect the updateESP function to run every frame
RunService.RenderStepped:Connect(updateESP)
